language: php

env:
  global:
    - DEFAULT_COMPOSER_FLAGS="--prefer-dist --no-interaction --no-progress --optimize-autoloader"
    - TASK_STATIC_ANALYSIS=0
    - TASK_TESTS_COVERAGE=0

matrix:
  include:
    - php: "7.4"
      env:
        - TASK_STATIC_ANALYSIS=0 # set to 1 to enable static analysis
        - TASK_TESTS_COVERAGE=1

# faster builds on new travis setup not using sudo
sudo: false

# cache vendor dirs
cache:
  directories:
    - $HOME/.composer/cache

before_install:
  - phpenv config-rm xdebug.ini || echo "xdebug is not installed"

install:
  - travis_retry composer self-update && composer --version
  - export PATH="$HOME/.composer/vendor/bin:$PATH"
  - travis_retry composer install $DEFAULT_COMPOSER_FLAGS
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      pecl install ast
    fi

before_script:
  - php --version
  - composer --version
  # enable code coverage
  - |
    if [ $TASK_TESTS_COVERAGE == 1 ]; then
        PHPUNIT_COVERAGE_FLAG="--coverage-clover=coverage.clover"
    fi

script:
  - phpdbg -qrr vendor/bin/phpunit --verbose $PHPUNIT_COVERAGE_FLAG
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      composer phan
    fi
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      cat analysis.txt
    fi

after_script:
  - |
    if [ $TASK_TESTS_COVERAGE == 1 ]; then
      travis_retry wget https://scrutinizer-ci.com/ocular.phar
      php ocular.phar code-coverage:upload --format=php-clover coverage.clover
    fi

notifications:
  slack:
    -
      rooms:
        -
          secure: cAU9TGFgVRW4fVbjnEDrTi5BncF1LdeWzBwJGPEvFx70M0W+Z2vIuXeWkVh9OiSLYKGBbqcVITbDZXFLBdBjQHz2UUx0cNYQRP24HRbCCA6ITC4V4M1r/mkNv2frG/0+WMvH6wDoLyyd7n5mPotf2apzMY4VYxpuHky00f47tiGO4ZpWXMk33M/Y47gKbgNNjsNrC0BhInPDgXSt/y9+jvJL+neqH9AAHioBO1UwRwjo7g5obQTw5qhehVy79Mtco/UkI3XnBdfinr3NW/NSCvN6FJ6UHX1tbnsbFUHsxA3m+1HKE+WqWKBXPRmZQ4OW00y7dU6qpjy+qfmCd411Ls2/UDDGKINS0yhqeiJcoLQahz/1gcmlcT2uW+ZYVVZqJZbP4sHGhQHEKqo1yxfqOJ8J5nb+ReBVsitOCqipPXLhJrPSapdUukd+AmGfZD+rmAmyed9wn8ukByQ9PgAJHGi2uicHjJMFulGTo/PkyxduHivUXtHyWozrgeDYBeBnwAAYQIQegkm/9E/nIEwzBRkXKcHbEpXts48zrrGKfBzOdCQid3Uh8OBC6QNl+Mnr92hEE562UT+lVvMVAPIQghpCkNIhJPGfVubsX9vpIE5I5GloTLEtRs7FnChPWAUjLExy5pVrWLsLK0KMLwUReD5b9cW0cHy/E2x7vlbWw4Q=
      on_success: always
      on_failure: never
      on_pull_requests: false
    -
      rooms:
        -
          secure: EK2d1QRUn8uDbzF/R3A4DV+s4/6LcJgIB0exjRd47b5KEubW0eCUaSP/cDIYYxsRX0rNMEge/8/Ql0u5cEYea3JZo2mdVbXkgYxwSWWLw/EE1zxDj/itIu/cPiRQaoywp9qnmIOGiiFJLgpRVQ+PWp7FmmoZWLwssjy6vODwc492Q1bkZF1khCkIiQLVOfBupGounCeXXi3DPzycBfDG2Y4iwRbCKXZS4j8dE+k64qRUhnS3sZ0kdqZGhm+01yx64R8ItJjFZXc5hMwkiupV/WYr64Ojjj+td88Jgnog86b8dz5qg7ylKWDjRZL6uAGOSSZTqUQAq3831i4IOK1mOWeT1Zc0qSQZKio0maw2w/URJcuBpKklYj+JoPB5obRQuu0nfbPNPVSBgvEStVaYN1BuzMIQ3nN/9vK2uU0+qMs+JjsYbMZZGnzqbu6YVX8XabhjcSzwzhjG2jeWG+mMflcZedQMhegAkWmzCp0YroJnVV7bPxIAVgE/G9M1kOemiOlBFAMz8XPazTaF+SpJ8EuqFVa/tw5+awAJ42EpFyq8JbV+Wq7vVXf60O7r53f6FTR8Lbfwz20c1JsVtcNVCo0O7SfFDS9bGgUyJmS6CceeN80ujgWRm5c5AC6zZO712MXd9WNXNGOEXO8pVb6CQMAeHsXYDT+ZdIlwPUjv5dc=
      on_success: never
      on_failure: always
      on_pull_requests: false
